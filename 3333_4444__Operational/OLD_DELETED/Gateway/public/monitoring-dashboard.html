<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHASE 1 - PCM Cross-Patch + MIC Monitoring</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #00d9ff;
      margin-bottom: 10px;
      font-size: 2em;
    }
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 30px;
      font-size: 0.9em;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    .section-title {
      color: #00d9ff;
      font-size: 1.3em;
      margin-bottom: 15px;
      padding-left: 10px;
      border-left: 4px solid #00d9ff;
    }
    .monitors {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .monitor-panel {
      background: #16213e;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid #0f3460;
    }
    .monitor-panel.mic {
      border-color: #ff6b35;
    }
    .monitor-panel h2 {
      color: #00d9ff;
      margin-bottom: 15px;
      font-size: 1.3em;
    }
    .monitor-panel.mic h2 {
      color: #ff6b35;
    }
    .monitor-label {
      font-size: 0.85em;
      color: #888;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    canvas {
      width: 100%;
      height: 120px;
      background: #0a1929;
      border-radius: 5px;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      background: #0a1929;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .status-item {
      padding: 5px 0;
      border-bottom: 1px solid #16213e;
    }
    .status-item:last-child {
      border-bottom: none;
    }
    .status-label {
      color: #00d9ff;
      font-weight: bold;
    }
    .connected { color: #00ff88; }
    .disconnected { color: #ff4444; }
    .stats-panel {
      background: #16213e;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid #0f3460;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-box {
      background: #0a1929;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }
    .stat-value {
      font-size: 2em;
      color: #00d9ff;
      font-weight: bold;
    }
    .stat-label {
      font-size: 0.9em;
      color: #888;
      margin-top: 5px;
    }
    button {
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px 5px 0 0;
      font-size: 0.85em;
    }
    button:hover {
      background: #00b8d4;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    button.playing {
      background: #ff6b35;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéôÔ∏è PHASE 1 - PCM Cross-Patch + MIC Monitoring</h1>
    <div class="subtitle">Real-time audio monitoring for extensions 3333 and 4444</div>

    <!-- MIC Monitoring Section -->
    <div class="section-title">üé§ MICROPHONE MONITORING (what they SAY)</div>
    <div class="monitors">
      <!-- Extension 3333 MIC -->
      <div class="monitor-panel mic">
        <h2>üé§ Extension 3333 MIC</h2>
        <div class="monitor-label">Raw audio from 3333's microphone (before cross-patch)</div>
        <canvas id="canvasMic3333"></canvas>
        <button id="playMic3333">üîä Enable Audio</button>
        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span id="statusMic3333" class="disconnected">Disconnected</span>
          </div>
          <div class="status-item">
            <span class="status-label">Packets:</span>
            <span id="packetsMic3333">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Volume:</span>
            <span id="volumeMic3333">0%</span>
          </div>
        </div>
      </div>

      <!-- Extension 4444 MIC -->
      <div class="monitor-panel mic">
        <h2>üé§ Extension 4444 MIC</h2>
        <div class="monitor-label">Raw audio from 4444's microphone (before cross-patch)</div>
        <canvas id="canvasMic4444"></canvas>
        <button id="playMic4444">üîä Enable Audio</button>
        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span id="statusMic4444" class="disconnected">Disconnected</span>
          </div>
          <div class="status-item">
            <span class="status-label">Packets:</span>
            <span id="packetsMic4444">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Volume:</span>
            <span id="volumeMic4444">0%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Monitor Section -->
    <div class="section-title">üîä SPEAKER MONITORING (what they HEAR)</div>
    <div class="monitors">
      <!-- Extension 3333 Monitor -->
      <div class="monitor-panel">
        <h2>üîä Extension 3333 Speaker</h2>
        <div class="monitor-label">Audio sent to 3333 (from 4444, after cross-patch)</div>
        <canvas id="canvas3333"></canvas>
        <button id="play3333">üîä Enable Audio</button>
        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span id="status3333" class="disconnected">Disconnected</span>
          </div>
          <div class="status-item">
            <span class="status-label">Packets:</span>
            <span id="packets3333">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Volume:</span>
            <span id="volume3333">0%</span>
          </div>
        </div>
      </div>

      <!-- Extension 4444 Monitor -->
      <div class="monitor-panel">
        <h2>üîä Extension 4444 Speaker</h2>
        <div class="monitor-label">Audio sent to 4444 (from 3333, after cross-patch)</div>
        <canvas id="canvas4444"></canvas>
        <button id="play4444">üîä Enable Audio</button>
        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span id="status4444" class="disconnected">Disconnected</span>
          </div>
          <div class="status-item">
            <span class="status-label">Packets:</span>
            <span id="packets4444">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Volume:</span>
            <span id="volume4444">0%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- System Stats -->
    <div class="stats-panel">
      <h2>üìä System Statistics</h2>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="uptime">0s</div>
          <div class="stat-label">Uptime</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalPackets">0</div>
          <div class="stat-label">Total Packets</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="crossPatchRate">0</div>
          <div class="stat-label">Cross-Patch Rate</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="wsClients">0</div>
          <div class="stat-label">WebSocket Clients</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const WS_HOST = window.location.hostname;
    const WS_PORT = window.location.port || '3010';

    // WebSocket connections
    let ws3333, ws4444, wsMic3333, wsMic4444, wsStatus;
    let audioCtx;
    let audioEnabled = { '3333': false, '4444': false, 'mic3333': false, 'mic4444': false };

    // Statistics
    let stats = {
      '3333': { packets: 0, volume: 0 },
      '4444': { packets: 0, volume: 0 },
      'mic3333': { packets: 0, volume: 0 },
      'mic4444': { packets: 0, volume: 0 }
    };

    // Canvas setup
    function setupCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = 120;
      return { canvas, ctx };
    }

    const { ctx: ctx3333 } = setupCanvas('canvas3333');
    const { ctx: ctx4444 } = setupCanvas('canvas4444');
    const { ctx: ctxMic3333 } = setupCanvas('canvasMic3333');
    const { ctx: ctxMic4444 } = setupCanvas('canvasMic4444');

    // Initialize WebSocket connections
    function connectWebSockets() {
      // Extension 3333 monitoring (what 3333 HEARS)
      ws3333 = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/monitor/3333`);
      ws3333.onopen = () => {
        document.getElementById('status3333').textContent = 'Connected';
        document.getElementById('status3333').className = 'connected';
      };
      ws3333.onclose = () => {
        document.getElementById('status3333').textContent = 'Disconnected';
        document.getElementById('status3333').className = 'disconnected';
        setTimeout(() => connectWebSockets(), 3000);
      };
      ws3333.onmessage = (event) => handleAudioData(event, '3333', ctx3333);

      // Extension 4444 monitoring (what 4444 HEARS)
      ws4444 = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/monitor/4444`);
      ws4444.onopen = () => {
        document.getElementById('status4444').textContent = 'Connected';
        document.getElementById('status4444').className = 'connected';
      };
      ws4444.onclose = () => {
        document.getElementById('status4444').textContent = 'Disconnected';
        document.getElementById('status4444').className = 'disconnected';
        setTimeout(() => connectWebSockets(), 3000);
      };
      ws4444.onmessage = (event) => handleAudioData(event, '4444', ctx4444);

      // Extension 3333 MIC monitoring (what 3333 SAYS)
      wsMic3333 = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/mic/3333`);
      wsMic3333.onopen = () => {
        document.getElementById('statusMic3333').textContent = 'Connected';
        document.getElementById('statusMic3333').className = 'connected';
      };
      wsMic3333.onclose = () => {
        document.getElementById('statusMic3333').textContent = 'Disconnected';
        document.getElementById('statusMic3333').className = 'disconnected';
        setTimeout(() => connectWebSockets(), 3000);
      };
      wsMic3333.onmessage = (event) => handleAudioData(event, 'mic3333', ctxMic3333);

      // Extension 4444 MIC monitoring (what 4444 SAYS)
      wsMic4444 = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/mic/4444`);
      wsMic4444.onopen = () => {
        document.getElementById('statusMic4444').textContent = 'Connected';
        document.getElementById('statusMic4444').className = 'connected';
      };
      wsMic4444.onclose = () => {
        document.getElementById('statusMic4444').textContent = 'Disconnected';
        document.getElementById('statusMic4444').className = 'disconnected';
        setTimeout(() => connectWebSockets(), 3000);
      };
      wsMic4444.onmessage = (event) => handleAudioData(event, 'mic4444', ctxMic4444);

      // Status monitoring
      wsStatus = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/status`);
      wsStatus.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'status') {
          document.getElementById('uptime').textContent = data.uptime + 's';
          const totalPackets = (data.stats.from3333Packets || 0) + (data.stats.from4444Packets || 0);
          document.getElementById('totalPackets').textContent = totalPackets;
          document.getElementById('crossPatchRate').textContent =
            Math.round((data.stats.to3333Packets || 0) + (data.stats.to4444Packets || 0));
          document.getElementById('wsClients').textContent = data.stats.wsConnections || 0;
        }
      };
    }

    // Handle incoming audio data
    function handleAudioData(event, extension, ctx) {
      const data = JSON.parse(event.data);
      if (data.type !== 'audio') return;

      stats[extension].packets++;
      const packetId = extension.charAt(0).toUpperCase() + extension.slice(1);
      document.getElementById(`packets${packetId}`).textContent = stats[extension].packets;

      // Draw waveform
      const pcm = new Float32Array(data.pcm);
      drawWaveform(ctx, pcm);

      // Calculate volume
      const volume = calculateVolume(pcm);
      stats[extension].volume = volume;
      document.getElementById(`volume${packetId}`).textContent = Math.round(volume * 100) + '%';

      // Play audio if enabled
      if (audioEnabled[extension] && audioCtx) {
        playAudio(pcm, data.sampleRate);
      }
    }

    // Draw waveform
    function drawWaveform(ctx, pcm) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const sliceWidth = width / pcm.length;

      ctx.fillStyle = '#0a1929';
      ctx.fillRect(0, 0, width, height);

      ctx.strokeStyle = '#00d9ff';
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let i = 0; i < pcm.length; i++) {
        const x = i * sliceWidth;
        const y = (pcm[i] + 1) / 2 * height;
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }

      ctx.stroke();
    }

    // Calculate volume (RMS)
    function calculateVolume(pcm) {
      let sum = 0;
      for (let i = 0; i < pcm.length; i++) {
        sum += pcm[i] * pcm[i];
      }
      return Math.sqrt(sum / pcm.length);
    }

    // Play audio
    function playAudio(pcm, sampleRate) {
      if (!audioCtx) return;

      const buffer = audioCtx.createBuffer(1, pcm.length, sampleRate);
      buffer.copyToChannel(pcm, 0);

      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start();
    }

    // Toggle audio playback handlers
    function setupAudioToggle(id, key) {
      document.getElementById(id).addEventListener('click', function() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioEnabled[key] = !audioEnabled[key];
        this.className = audioEnabled[key] ? 'playing' : '';
        this.textContent = audioEnabled[key] ? 'üîá Disable Audio' : 'üîä Enable Audio';
      });
    }

    // Setup all audio toggles
    setupAudioToggle('play3333', '3333');
    setupAudioToggle('play4444', '4444');
    setupAudioToggle('playMic3333', 'mic3333');
    setupAudioToggle('playMic4444', 'mic4444');

    // Initialize
    connectWebSockets();
  </script>
</body>
</html>

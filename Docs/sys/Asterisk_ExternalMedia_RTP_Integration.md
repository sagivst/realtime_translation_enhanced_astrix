
Asterisk ExternalMedia RTP Integration – Full Engineering Specification

For 16 kHz slin16 Bidirectional Audio Processing Pipelines

Version: 1.0
Author: Engineering
Audience: VoIP Engineers, AI Audio Pipeline Developers, Gateway Developers

⸻

1. Overview

This document describes the exact technical requirements, configuration, and integration path for connecting:
	•	Asterisk ExternalMedia (RTP mode)
	•	A Node.js Media Gateway
	•	Your Real-Time AI Translation Server (STT → MT → TTS)
	•	SIP endpoints at 16kHz (G.722)

It details the audio format, RTP behavior, timestamp rules, endianness, and the exact reason for the previously observed slow-motion audio and silent failures.

This specification ensures that Asterisk can reliably receive and play PCM audio generated by your AI pipeline.

⸻

2. Expected Audio Format (slin16)

Asterisk’s slin16 format is defined as:

Parameter	Value
Type	Signed Linear PCM
Sample Rate	16000 Hz
Channels	1 (mono)
Bit Depth	16-bit
Endianness	Little-Endian
Frame Size	20 ms
Samples per Frame	320 samples
Bytes per Frame	640 bytes

These values must be strictly followed.

If audio does not match these values, Asterisk will:
	•	slow playback
	•	distort audio
	•	or discard packets entirely

⸻

3. RTP Requirements for ExternalMedia

3.1 RTP Payload Structure

Each RTP packet must contain:

640-byte payload (PCM16 LE) → representing EXACTLY 20 ms

3.2 RTP Timestamp Increment

For 16kHz audio:

timestamp_next = timestamp_previous + 320

This must match the real duration of the frame.

If you send:
	•	640 bytes (20ms)
	•	but timestamp increments 960 (48kHz)

Asterisk will slow the audio by 3×.

This was the cause of your “slow-motion voice”.

⸻

4. Payload Type (PT) Behavior

Asterisk does not use the RTP payload type to determine format.

It uses only:

"format": "slin16"

in the ExternalMedia ARI request.

Therefore:
	•	PT=10 (L16) → works
	•	PT=96 (dynamic) → works
	•	PT=126 → works
as long as the audio is valid slin16, LE, and timing-correct

Why PT=96 caused silence earlier:
	•	Your code triggered an endian swap based on PT
	•	Byte swap corrupted valid PCM
	•	Asterisk discarded corrupted PCM → silence

⸻

5. Endianness Requirements

From source code:

slin16 → LITTLE-ENDIAN ONLY

This means:

Direction	Endianness
Asterisk → Gateway	ALWAYS Big-Endian (RFC 3551 L16)
Gateway → Asterisk	MUST be Little-Endian (slin16)

Therefore:

Required conversions

Inbound:
  RTP L16 BE  → PCM16 LE  (byte swap ONCE)

Outbound:
  PCM16 LE → RTP slin16 LE (NO SWAP)

Failure to follow this causes:
	•	silence
	•	distortion
	•	buzzer-like patterns

⸻

6. Complete Audio Flow (Corrected)

[SIP Phone 1] 16kHz G.722
      ↓ RTP
[Asterisk ExternalMedia]
      ↓ RTP (PT=10 or 96, 20ms, BE)
[Gateway]
      ↓ Byte-swap → Little-Endian
      ↓ PCM16 LE
[AI Pipeline: STT → MT → TTS]
      ↓ PCM16 LE @ 16kHz
[Gateway]
      ↓ RTP (PT 10 or 96, LE, timestamps +320)
[Asterisk ExternalMedia]
      ↓ RTP → Conference Bridge
[SIP Phone 2]


⸻

7. Asterisk ARI Configuration

Example ExternalMedia creation:

POST /ari/channels/externalMedia

{
  "app": "media_app",
  "external_host": "127.0.0.1:5000",
  "format": "slin16",
  "direction": "both",
  "encapsulation": "rtp"
}

This tells Asterisk to expect:
	•	slin16
	•	640-byte payloads
	•	20ms per packet
	•	LE PCM

⸻

8. Required Gateway Behavior

8.1 Inbound RTP handler
	•	Read RTP payload
	•	Interpret as big-endian PCM16
	•	Convert to little-endian PCM16
	•	Forward to AI pipeline

8.2 Outbound RTP generator
	•	Accept PCM16 LE from TTS
	•	DO NOT convert endian
	•	Frame into 640-byte RTP payloads
	•	Increment timestamps by 320
	•	Transmit every 20ms ±2ms jitter max

⸻

9. Why audio slowed to 3× earlier

Your system generated audio at 48kHz, but timestamp increments indicated 16kHz.

Mathematically:

48kHz / 16kHz = 3× slower playback

Asterisk rebuilt the audio timeline based on timestamps, not actual frame size.

⸻

10. Why PT=96 and PT=126 resulted in silence

Because your gateway logic did:

if PT != expected:
    no swap → PCM correct → but slow
else:
    swap → PCM corrupted → Asterisk discards → silence

The PT itself was NOT the issue.

⸻

11. Testing Checklist

Before sending audio to Asterisk, verify:

✔ Sample rate = 16000
✔ Channels = mono
✔ Bit depth = 16-bit
✔ Endianness = Little-Endian
✔ Frame size = 640 bytes
✔ RTP TS increment = 320
✔ Packet interval = 20ms

Tools recommended:
	•	ffprobe
	•	sox
	•	Wireshark (rtp.player + payload checks)

⸻

12. Common Failure Modes

Symptom	Cause
Slow voice	Wrong timestamp increments (48kHz vs 16kHz)
Silence	Invalid PCM (wrong endian, wrong frame size)
Buzzer / distortion	Mixed endian frames
Choppy audio	Incorrect packet timing (too fast/slow)
“Pops”	Sending >20ms bursts or missing RTP seq numbers


⸻

13. Requirements Summary (TL;DR)

SEND TO ASTERISK:

Format: slin16
Endian: LITTLE
Rate: 16000 Hz
Bytes: 640
Samples: 320
Duration: 20ms
Timestamp increment: 320
Timing: 20ms interval
Payload: any (10 recommended)

If all fields match → audio ALWAYS works.

; Asterisk Dialplan Configuration
; Extension 7000 - AudioSocket with Recording for Debugging
; Extension 1000 - Conference Room
; Conference Test Context - Plays audio for testing

[default]
; Extension 7000 - AudioSocket (exact match has priority over pattern)
exten => 7000,1,Goto(from-sip-custom,7000,1)

; Extension 7001 - AudioSocket (port 5052)
exten => 7001,1,Goto(from-sip-custom,7001,1)
n; TEST Extensions for ExternalMedia
exten => 7777,1,Goto(externalmedia-test,7777,1)
exten => 8888,1,Goto(externalmedia-test,8888,1)

; Extension 7004 - Simple AudioSocket (like 7000)
exten => 7004,1,NoOp(=== Extension 7004: Simple AudioSocket ===)
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Answer()
 same => n,Playback(beep)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Extension 7004 UUID: ${CALL_UUID})
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:5050)
 same => n,Hangup()

; Extension 7005 - Simple AudioSocket (like 7001)
exten => 7005,1,NoOp(=== Extension 7005: Simple AudioSocket ===)
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Answer()
 same => n,Playback(beep)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Extension 7005 UUID: ${CALL_UUID})
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:5052)
 same => n,Hangup()

; Conference rooms 1000-9999
exten => _[1-9]XXX,1,NoOp(=== Conference Room ${EXTEN} ===)
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Set(CONFERENCE_ID=${EXTEN})
 same => n,Goto(translation-conference,${EXTEN},1)

; Reject all other extensions (bots, scanners, invalid)
exten => _X.,1,NoOp(=== REJECTED: Invalid extension ${EXTEN} ===)
 same => n,Playtones(congestion)
 same => n,Hangup()

[from-internal]
; GStreamer Phase 1 test extensions
exten => 5555,1,Goto(gstreamer-phase1,5555,1)
exten => 6666,1,Goto(gstreamer-phase1,6666,1)
; Extension 7000 - AudioSocket
exten => 7000,1,Goto(from-sip-custom,7000,1)

; Extension 7001 - AudioSocket (port 5052)
exten => 7001,1,Goto(from-sip-custom,7001,1)
n; TEST Extensions for ExternalMedia
exten => 7777,1,Goto(externalmedia-test,7777,1)
exten => 8888,1,Goto(externalmedia-test,8888,1)

; Extension 7004 - Simple AudioSocket (like 7000)
exten => 7004,1,NoOp(=== Extension 7004: Simple AudioSocket ===)
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Answer()
 same => n,Playback(beep)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Extension 7004 UUID: ${CALL_UUID})
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:5050)
 same => n,Hangup()

; Extension 7005 - Simple AudioSocket (like 7001)
exten => 7005,1,NoOp(=== Extension 7005: Simple AudioSocket ===)
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Answer()
 same => n,Playback(beep)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Extension 7005 UUID: ${CALL_UUID})
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:5052)
 same => n,Hangup()

; Conference room 1000
exten => 1000,1,Goto(translation-conference,1000,1)

; Conference room 2000
exten => 2000,1,Goto(translation-conference,2000,1)

; Echo test
exten => 8888,1,NoOp(Echo test)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,Playback(hello-world)
 same => n,Echo()
 same => n,Hangup()

; Test audio extension (plays tone continuously)
exten => 9999,1,NoOp(=== Audio Test ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,Playback(hello-world)
 same => n,Playback(demo-congrats)
 same => n,Wait(1)
 same => n,Playback(hello-world)
 same => n,Playback(demo-congrats)
 same => n,Wait(1)
 same => n,Goto(3)

[public]
exten => 7000,1,Goto(from-sip-custom,7000,1)

; Extension 7001 - AudioSocket (port 5052)
exten => 7001,1,Goto(from-sip-custom,7001,1)
n; TEST Extensions for ExternalMedia
exten => 7777,1,Goto(externalmedia-test,7777,1)
exten => 8888,1,Goto(externalmedia-test,8888,1)

exten => _X.,1,NoOp(=== Default Context ===)
 same => n,Playback(invalid)
 same => n,Hangup()

; AudioSocket extension for 7000 - WITH MULTI-LANGUAGE CONFERENCE BRIDGE AUTO-DIALING
[from-sip-custom]
exten => 7000,1,NoOp(=== Multi-Language Conference Bridge with Auto-Dialing ===)
 same => n,Set(CONFERENCE_ID=7000)
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,Playback(beep)

 ; Get language settings from global variables (set by dashboard)
 same => n,Set(SOURCE_LANG=${GLOBAL(qa_source_lang)})
 same => n,Set(TARGET_LANG=${GLOBAL(qa_target_lang)})
 same => n,Set(CUSTOMER_EXT=${GLOBAL(qa_customer_extension)})

 ; Determine which bridge the agent should join
 ; Use qa_agent_bridge if set (for Extension 7004), otherwise calculate from SOURCE_LANG
 same => n,Set(AGENT_BRIDGE=${IF($["${GLOBAL(qa_agent_bridge)}" != ""]?${GLOBAL(qa_agent_bridge)}:${IF($["${SOURCE_LANG}" = "en"]?1000:2000)})})
 same => n,Set(CUSTOMER_BRIDGE=${IF($["${GLOBAL(qa_customer_bridge)}" != ""]?${GLOBAL(qa_customer_bridge)}:${IF($["${SOURCE_LANG}" = "en"]?2000:1000)})})

 same => n,NoOp(Agent will join bridge: ${AGENT_BRIDGE})
 same => n,NoOp(Customer will join bridge: ${CUSTOMER_BRIDGE})
 same => n,NoOp(Customer extension: ${CUSTOMER_EXT})

 ; Initiate outbound call to customer extension if selected
 same => n,GotoIf($["${CUSTOMER_EXT}" = ""]?skip_autodial)
 same => n,NoOp(Initiating outbound call to customer extension: ${CUSTOMER_EXT})
 same => n,System(asterisk -rx "channel originate PJSIP/${CUSTOMER_EXT} application ConfBridge ${CUSTOMER_BRIDGE},default_bridge,default_user" &)

 ; Join agent to appropriate bridge with AudioSocket for translation
 same => n(skip_autodial),NoOp(Joining agent to bridge ${AGENT_BRIDGE} via AudioSocket)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Call UUID: ${CALL_UUID})
 same => n,Set(RECORDING_FILE=/tmp/recording-${CALL_UUID})
same => n,AudioSocket(${CALL_UUID},127.0.0.1:5050)
 same => n,Hangup()

; Extension 7001 - Second AudioSocket orchestrator (port 5052)
exten => 7001,1,NoOp(=== Multi-Language Conference Bridge 7001 ===)
 same => n,Set(CONFERENCE_ID=7001)
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,Playback(beep)

 ; Get language settings from global variables (set by dashboard)
 same => n,Set(SOURCE_LANG=${GLOBAL(qa_source_lang)})
 same => n,Set(TARGET_LANG=${GLOBAL(qa_target_lang)})
 same => n,Set(CUSTOMER_EXT=${GLOBAL(qa_customer_extension)})

 ; Determine which bridge the agent should join
 ; Use qa_agent_bridge if set (for Extension 7004), otherwise calculate from SOURCE_LANG
 same => n,Set(AGENT_BRIDGE=${IF($["${GLOBAL(qa_agent_bridge)}" != ""]?${GLOBAL(qa_agent_bridge)}:${IF($["${SOURCE_LANG}" = "en"]?1000:2000)})})
 same => n,Set(CUSTOMER_BRIDGE=${IF($["${GLOBAL(qa_customer_bridge)}" != ""]?${GLOBAL(qa_customer_bridge)}:${IF($["${SOURCE_LANG}" = "en"]?2000:1000)})})

 same => n,NoOp(Agent will join bridge: ${AGENT_BRIDGE})
 same => n,NoOp(Customer will join bridge: ${CUSTOMER_BRIDGE})
 same => n,NoOp(Customer extension: ${CUSTOMER_EXT})

 ; Initiate outbound call to customer extension if selected
 same => n,GotoIf($["${CUSTOMER_EXT}" = ""]?skip_autodial)
 same => n,NoOp(Initiating outbound call to customer extension: ${CUSTOMER_EXT})
 same => n,System(asterisk -rx "channel originate PJSIP/${CUSTOMER_EXT} application ConfBridge ${CUSTOMER_BRIDGE},default_bridge,default_user" &)

 ; Join agent to appropriate bridge with AudioSocket for translation
 same => n(skip_autodial),NoOp(Joining agent to bridge ${AGENT_BRIDGE} via AudioSocket)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Call UUID: ${CALL_UUID})
 same => n,Set(RECORDING_FILE=/tmp/recording-${CALL_UUID})
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:5052)
 same => n,Hangup()

; ============================================================================
; Extension listen-7000 - Muted Listener for Bridge 7000
; ============================================================================
exten => listen-7000,1,NoOp(=== Muted Listener for Bridge 7000 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,ConfBridge(7000,default_bridge,muted_listener)
 same => n,Hangup()

; ============================================================================
; Extension listen-7001 - Muted Listener for Bridge 7001
; ============================================================================
exten => listen-7001,1,NoOp(=== Muted Listener for Bridge 7001 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,ConfBridge(7001,default_bridge,muted_listener)
 same => n,Hangup()

; ============================================================================
; Extension 7006 - Muted Monitor for Bridge 7004
; ============================================================================
exten => 7006,1,NoOp(=== Muted Monitor for Bridge 7004 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,ConfBridge(7004,default_bridge,muted_listener)
 same => n,Hangup()

; ============================================================================
; Extension 7007 - Muted Monitor for Bridge 7005
; ============================================================================
exten => 7007,1,NoOp(=== Muted Monitor for Bridge 7005 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,ConfBridge(7005,default_bridge,muted_listener)
 same => n,Hangup()

; ============================================================================
; Extension 8000 - Simple AudioSocket for Bridge 7004 (NO ARI complications)
; ============================================================================
exten => 8000,1,NoOp(=== Extension 8000: Simple AudioSocket ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,Set(CALL_UUID=${FILTER(a-zA-Z0-9-,${SHELL(uuidgen)})})
 same => n,NoOp(Extension 8000 UUID: ${CALL_UUID})
 same => n,AudioSocket(${CALL_UUID},127.0.0.1:5050)
 same => n,Hangup()


[translation-conference]
; Translation conference room (1000-9999)
exten => _X.,1,NoOp(=== Translation Conference Room ${EXTEN} ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,Stasis(translation-app,${EXTEN})
 same => n,Hangup()

; Test audio context - used by automated test script
[conference-test]
exten => test-audio,1,NoOp(=== Conference Test Audio ===)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(hello-world)
 same => n,Playback(demo-congrats)
 same => n,Playback(demo-abouttotry)
 same => n,Playback(demo-echotest)
 same => n,Wait(2)
 same => n,Goto(3)  ; Loop: play audio continuously

[local-autodial]
exten => 1001-to-7000,1,NoOp(Auto-dialing 1001 to bridge 7000)
 same => n,Answer()
 same => n,ConfBridge(7000,default_bridge,default_user)
 same => n,Hangup()

; ============================================
; TEST CONTEXT FOR EXTERNALMEDIA (DO NOT TOUCH PRODUCTION)
; Extensions 7777 and 8888 - Isolated test system
; ============================================
[externalmedia-test]

exten => 7777,1,NoOp(=== ExternalMedia Test - Extension 7777 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,NoOp(Volume adjustment disabled)
 same => n,Set(AUDIOHOOK_INHERIT(func_volume)=yes)
 same => n,Stasis(translation-test,ext7777)
 same => n,Hangup()

exten => 8888,1,NoOp(=== ExternalMedia Test - Extension 8888 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin48)
 same => n,NoOp(Volume adjustment disabled)
 same => n,Set(AUDIOHOOK_INHERIT(func_volume)=yes)
 same => n,Stasis(translation-test,ext8888)
 same => n,Hangup()

; ============================================
; GSTREAMER PHASE 1 TEST CONTEXT
; Extensions 5555 and 6666 - Isolated PCM Cross-Patch Test
; Uses ExternalMedia with GStreamer pipelines
; Added: $(date +%Y-%m-%d)
; ============================================
[gstreamer-phase1]

; Extension 5555 â†’ ExternalMedia instance gs5555
exten => 5555,1,NoOp(=== GStreamer Phase 1 - Extension 5555 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin16)
 same => n,Playback(beep)
 same => n,NoOp(Starting ExternalMedia on port 4000/4001)
 same => n,Stasis(gstreamer-phase1,ext5555)
 same => n,Hangup()

; Extension 6666 â†’ ExternalMedia instance gs6666
exten => 6666,1,NoOp(=== GStreamer Phase 1 - Extension 6666 ===)
 same => n,Answer()
 same => n,Set(CHANNEL(format)=slin16)
 same => n,Playback(beep)
 same => n,NoOp(Starting ExternalMedia on port 4002/4003)
 same => n,Stasis(gstreamer-phase1,ext6666)
 same => n,Hangup()

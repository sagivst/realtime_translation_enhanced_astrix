<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHASE 1 - PCM Cross-Patch Monitoring</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #00d9ff;
      margin-bottom: 30px;
      font-size: 2em;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .monitors {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .monitor-panel {
      background: #16213e;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid #0f3460;
    }
    .monitor-panel h2 {
      color: #00d9ff;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    canvas {
      width: 100%;
      height: 150px;
      background: #0a1929;
      border-radius: 5px;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      background: #0a1929;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.9em;
    }
    .status-item {
      padding: 5px 0;
      border-bottom: 1px solid #16213e;
    }
    .status-item:last-child {
      border-bottom: none;
    }
    .status-label {
      color: #00d9ff;
      font-weight: bold;
    }
    .connected { color: #00ff88; }
    .disconnected { color: #ff4444; }
    .stats-panel {
      background: #16213e;
      border-radius: 10px;
      padding: 20px;
      border: 2px solid #0f3460;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-box {
      background: #0a1929;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }
    .stat-value {
      font-size: 2em;
      color: #00d9ff;
      font-weight: bold;
    }
    .stat-label {
      font-size: 0.9em;
      color: #888;
      margin-top: 5px;
    }
    button {
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      background: #00b8d4;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéôÔ∏è PHASE 1 - PCM Cross-Patch Monitoring</h1>

    <div class="monitors">
      <!-- Extension 5555 Monitor -->
      <div class="monitor-panel">
        <h2>üìû Extension 5555</h2>
        <canvas id="canvas5555"></canvas>
        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span id="status5555" class="disconnected">Disconnected</span>
          </div>
          <div class="status-item">
            <span class="status-label">Packets:</span>
            <span id="packets5555">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Volume:</span>
            <span id="volume5555">0%</span>
          </div>
        </div>
        <button id="toggleAudio5555" disabled>Enable Audio Playback</button>
      </div>

      <!-- Extension 6666 Monitor -->
      <div class="monitor-panel">
        <h2>üìû Extension 6666</h2>
        <canvas id="canvas6666"></canvas>
        <div class="status">
          <div class="status-item">
            <span class="status-label">Status:</span>
            <span id="status6666" class="disconnected">Disconnected</span>
          </div>
          <div class="status-item">
            <span class="status-label">Packets:</span>
            <span id="packets6666">0</span>
          </div>
          <div class="status-item">
            <span class="status-label">Volume:</span>
            <span id="volume6666">0%</span>
          </div>
        </div>
        <button id="toggleAudio6666" disabled>Enable Audio Playback</button>
      </div>
    </div>

    <!-- System Stats -->
    <div class="stats-panel">
      <h2>üìä System Statistics</h2>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-value" id="uptime">0s</div>
          <div class="stat-label">Uptime</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="totalPackets">0</div>
          <div class="stat-label">Total Packets</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="crossPatchRate">0</div>
          <div class="stat-label">Cross-Patch Rate</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="wsClients">0</div>
          <div class="stat-label">WebSocket Clients</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const WS_HOST = window.location.hostname;
    const WS_PORT = window.location.port || '3010';

    // WebSocket connections
    let ws5555, ws6666, wsStatus;
    let audioCtx;
    let audioEnabled = { '5555': false, '6666': false };

    // Statistics
    let stats = {
      '5555': { packets: 0, volume: 0 },
      '6666': { packets: 0, volume: 0 }
    };

    // Canvas setup
    const canvas5555 = document.getElementById('canvas5555');
    const ctx5555 = canvas5555.getContext('2d');
    canvas5555.width = canvas5555.offsetWidth;
    canvas5555.height = 150;

    const canvas6666 = document.getElementById('canvas6666');
    const ctx6666 = canvas6666.getContext('2d');
    canvas6666.width = canvas6666.offsetWidth;
    canvas6666.height = 150;

    // Initialize WebSocket connections
    function connectWebSockets() {
      // Extension 5555 monitoring
      ws5555 = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/monitor/5555`);
      ws5555.onopen = () => {
        document.getElementById('status5555').textContent = 'Connected';
        document.getElementById('status5555').className = 'connected';
        document.getElementById('toggleAudio5555').disabled = false;
      };
      ws5555.onclose = () => {
        document.getElementById('status5555').textContent = 'Disconnected';
        document.getElementById('status5555').className = 'disconnected';
        setTimeout(() => connectWebSockets(), 3000);
      };
      ws5555.onmessage = (event) => handleAudioData(event, '5555', ctx5555);

      // Extension 6666 monitoring
      ws6666 = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/monitor/6666`);
      ws6666.onopen = () => {
        document.getElementById('status6666').textContent = 'Connected';
        document.getElementById('status6666').className = 'connected';
        document.getElementById('toggleAudio6666').disabled = false;
      };
      ws6666.onclose = () => {
        document.getElementById('status6666').textContent = 'Disconnected';
        document.getElementById('status6666').className = 'disconnected';
        setTimeout(() => connectWebSockets(), 3000);
      };
      ws6666.onmessage = (event) => handleAudioData(event, '6666', ctx6666);

      // Status monitoring
      wsStatus = new WebSocket(`ws://${WS_HOST}:${WS_PORT}/status`);
      wsStatus.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'status') {
          document.getElementById('uptime').textContent = data.uptime + 's';
          const totalPackets = (data.stats.from5555Packets || 0) + (data.stats.from6666Packets || 0);
          document.getElementById('totalPackets').textContent = totalPackets;
          document.getElementById('crossPatchRate').textContent =
            Math.round((data.stats.to5555Packets || 0) + (data.stats.to6666Packets || 0));
          document.getElementById('wsClients').textContent = data.stats.wsConnections || 0;
        }
      };
    }

    // Handle incoming audio data
    function handleAudioData(event, extension, ctx) {
      const data = JSON.parse(event.data);
      if (data.type !== 'audio') return;

      stats[extension].packets++;
      document.getElementById(`packets${extension}`).textContent = stats[extension].packets;

      // Draw waveform
      const pcm = new Float32Array(data.pcm);
      drawWaveform(ctx, pcm);

      // Calculate volume
      const volume = calculateVolume(pcm);
      stats[extension].volume = volume;
      document.getElementById(`volume${extension}`).textContent = Math.round(volume * 100) + '%';

      // Play audio if enabled
      if (audioEnabled[extension] && audioCtx) {
        playAudio(pcm, data.sampleRate);
      }
    }

    // Draw waveform
    function drawWaveform(ctx, pcm) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const sliceWidth = width / pcm.length;

      ctx.fillStyle = '#0a1929';
      ctx.fillRect(0, 0, width, height);

      ctx.strokeStyle = '#00d9ff';
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let i = 0; i < pcm.length; i++) {
        const x = i * sliceWidth;
        const y = (pcm[i] + 1) / 2 * height;
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }

      ctx.stroke();
    }

    // Calculate volume (RMS)
    function calculateVolume(pcm) {
      let sum = 0;
      for (let i = 0; i < pcm.length; i++) {
        sum += pcm[i] * pcm[i];
      }
      return Math.sqrt(sum / pcm.length);
    }

    // Play audio
    function playAudio(pcm, sampleRate) {
      if (!audioCtx) return;

      const buffer = audioCtx.createBuffer(1, pcm.length, sampleRate);
      buffer.copyToChannel(pcm, 0);

      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start();
    }

    // Toggle audio playback
    document.getElementById('toggleAudio5555').addEventListener('click', () => {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      audioEnabled['5555'] = !audioEnabled['5555'];
      document.getElementById('toggleAudio5555').textContent =
        audioEnabled['5555'] ? 'Disable Audio Playback' : 'Enable Audio Playback';
    });

    document.getElementById('toggleAudio6666').addEventListener('click', () => {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      audioEnabled['6666'] = !audioEnabled['6666'];
      document.getElementById('toggleAudio6666').textContent =
        audioEnabled['6666'] ? 'Disable Audio Playback' : 'Enable Audio Playback';
    });

    // Initialize
    connectWebSockets();
  </script>
</body>
</html>

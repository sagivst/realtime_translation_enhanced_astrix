# Monitoring System Backup Plan
## Essential Files Only - No Garbage

**Created:** 2025-12-10
**Target:** Dev VM 20.170.155.53
**CRITICAL:** NEVER touch production VM (4.185.84.26)

---

## Backup Command (Single Command)

```bash
# Run this on Dev VM to create backup tarball
ssh azureuser@20.170.155.53 "cd /home/azureuser && tar -czvf monitoring-backup-$(date +%Y%m%d-%H%M%S).tar.gz \
  translation-app/monitoring-server.js \
  translation-app/monitoring-to-database-bridge.js \
  translation-app/database-api-server.js \
  translation-app/continuous-metrics-emitter.js \
  translation-app/3333_4444__Operational/STTTTSserver/station3-handler.js \
  translation-app/3333_4444__Operational/STTTTSserver/station9-handler.js \
  translation-app/3333_4444__Operational/STTTTSserver/monitoring/StationAgent.js \
  translation-app/3333_4444__Operational/STTTTSserver/monitoring/audio-analysis-utils.js \
  translation-app/3333_4444__Operational/STTTTSserver/config-factory-defaults.js \
  2>/dev/null"
```

---

## 1. ESSENTIAL FILES LIST

### 1.1 Core Monitoring Services (4 files)

| File | Path | Size | Purpose |
|------|------|------|---------|
| monitoring-server.js | /home/azureuser/translation-app/ | ~21KB | Central Socket.IO hub (Port 3001) |
| monitoring-to-database-bridge.js | /home/azureuser/translation-app/ | ~4KB | Forwards metrics to DB API |
| database-api-server.js | /home/azureuser/translation-app/ | ~2KB | HTTP API server (Port 8083) |
| continuous-metrics-emitter.js | /home/azureuser/translation-app/ | ~2KB | Baseline data emitter |

### 1.2 Station Handlers (2 files)

| File | Path | Size | Purpose |
|------|------|------|---------|
| station3-handler.js | /home/azureuser/translation-app/3333_4444__Operational/STTTTSserver/ | ~7KB | STT input monitoring (14 params) |
| station9-handler.js | /home/azureuser/translation-app/3333_4444__Operational/STTTTSserver/ | ~7KB | TTS output monitoring (15 params) |

### 1.3 Supporting Modules (3 files)

| File | Path | Size | Purpose |
|------|------|------|---------|
| StationAgent.js | /home/azureuser/translation-app/3333_4444__Operational/STTTTSserver/monitoring/ | ~10KB | Metrics collection agent |
| audio-analysis-utils.js | /home/azureuser/translation-app/3333_4444__Operational/STTTTSserver/monitoring/ | ~3KB | Audio metrics calculation |
| config-factory-defaults.js | /home/azureuser/translation-app/3333_4444__Operational/STTTTSserver/ | ~5KB | Config factory with defaults |

---

## 2. FILES TO BACKUP (9 TOTAL)

```
/home/azureuser/translation-app/
├── monitoring-server.js                    # BACKUP - Core hub
├── monitoring-to-database-bridge.js        # BACKUP - Bridge
├── database-api-server.js                  # BACKUP - API server
├── continuous-metrics-emitter.js           # BACKUP - Emitter
│
└── 3333_4444__Operational/STTTTSserver/
    ├── station3-handler.js                 # BACKUP - Station-3
    ├── station9-handler.js                 # BACKUP - Station-9
    ├── config-factory-defaults.js          # BACKUP - Config factory
    │
    └── monitoring/
        ├── StationAgent.js                 # BACKUP - Agent
        └── audio-analysis-utils.js         # BACKUP - Audio utils
```

---

## 3. RUNTIME CONFIGURATION FILES (Generated - No backup needed)

These files are generated at runtime and don't need backup:

```
/tmp/STATION_3-3333-config.json    # Generated by config factory
/tmp/STATION_3-4444-config.json    # Generated by config factory
/tmp/STATION_9-3333-config.json    # Generated by config factory
/tmp/STATION_9-4444-config.json    # Generated by config factory
```

---

## 4. DATABASE / STORAGE

**Type:** In-memory only (no persistent database)
**Storage:** Last 100 snapshots kept in memory
**File:** None - data is lost on restart

**Note:** No database backup needed - data is transient.

---

## 5. DO NOT BACKUP (Garbage / Generated / Logs)

```
# Log files - regenerated on restart
/tmp/*.log
/tmp/monitoring-*.log
/tmp/sttttserver-*.log
/tmp/database-api-*.log
/tmp/bridge-*.log
/tmp/cloudflared*.log
/tmp/gateway-*.log

# Backup files - old versions
*.backup*
*.bak*
*-backup-*

# Node modules - installed via npm
node_modules/

# Temporary files
*.tmp
*.temp

# Old monitoring files (superseded)
monitoring-server-55param-backup.js
monitoring-server-75param.js
monitoring-server-ai-calibration.js
monitoring-server-github.js
monitoring-server-real-data.js
continuous-full-monitoring-with-station3.js   # Replaced by continuous-metrics-emitter.js
monitoring-api-bridge.js                       # Optional, not required

# Old StationAgent versions
StationAgent.backup.js
StationAgent.js.backup
StationAgent.js.backup-*
StationAgent-Unified.js
UnifiedStationCollector.js
UnifiedStationCollector-original.js
UniversalCollector.js
RealTimeMetricsProvider.js
RealTimeMetricsProvider-Complete.js
```

---

## 6. EXTERNAL DEPENDENCIES (Installed via npm)

These are installed on the VM, not backed up:

```bash
# Check with: npm list --depth=0
socket.io          # For monitoring-server.js
socket.io-client   # For bridges
express            # For HTTP servers
axios              # For HTTP requests (bridge)
```

**Restore command:**
```bash
cd /home/azureuser/translation-app && npm install socket.io socket.io-client express axios
```

---

## 7. CLOUDFLARED BINARY (External tool)

**Location:** `/home/azureuser/cloudflared-linux-amd64`
**Size:** ~30MB
**Download URL:** https://github.com/cloudflare/cloudflared/releases

**Restore command:**
```bash
cd /home/azureuser && wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
chmod +x cloudflared-linux-amd64
```

---

## 8. BACKUP SCRIPT

Create this script on your local machine:

```bash
#!/bin/bash
# monitoring-backup.sh
# Run from local machine to backup monitoring system

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="./monitoring-backups"
BACKUP_NAME="monitoring-backup-${TIMESTAMP}"

mkdir -p ${BACKUP_DIR}

echo "=== Backing up Monitoring System ==="
echo "Timestamp: ${TIMESTAMP}"

# Create backup on VM
ssh azureuser@20.170.155.53 "cd /home/azureuser && tar -czvf /tmp/${BACKUP_NAME}.tar.gz \
  translation-app/monitoring-server.js \
  translation-app/monitoring-to-database-bridge.js \
  translation-app/database-api-server.js \
  translation-app/continuous-metrics-emitter.js \
  translation-app/3333_4444__Operational/STTTTSserver/station3-handler.js \
  translation-app/3333_4444__Operational/STTTTSserver/station9-handler.js \
  translation-app/3333_4444__Operational/STTTTSserver/monitoring/StationAgent.js \
  translation-app/3333_4444__Operational/STTTTSserver/monitoring/audio-analysis-utils.js \
  translation-app/3333_4444__Operational/STTTTSserver/config-factory-defaults.js \
  2>/dev/null"

# Download backup to local
scp azureuser@20.170.155.53:/tmp/${BACKUP_NAME}.tar.gz ${BACKUP_DIR}/

# Cleanup remote
ssh azureuser@20.170.155.53 "rm /tmp/${BACKUP_NAME}.tar.gz"

echo "=== Backup Complete ==="
echo "File: ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"
ls -lh ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz
```

---

## 9. RESTORE PROCEDURE

```bash
# 1. Copy backup to VM
scp monitoring-backup-XXXXXXXX-XXXXXX.tar.gz azureuser@20.170.155.53:/tmp/

# 2. SSH to VM
ssh azureuser@20.170.155.53

# 3. Stop all monitoring services
pkill -f monitoring-server
pkill -f monitoring-to-database-bridge
pkill -f database-api-server
pkill -f continuous-metrics-emitter

# 4. Extract backup
cd /home/azureuser
tar -xzvf /tmp/monitoring-backup-XXXXXXXX-XXXXXX.tar.gz

# 5. Install dependencies (if needed)
cd translation-app && npm install socket.io socket.io-client express axios

# 6. Start services in order
cd /home/azureuser/translation-app
nohup node database-api-server.js > /tmp/database-api.log 2>&1 &
sleep 2
nohup node monitoring-server.js > /tmp/monitoring-server.log 2>&1 &
sleep 2
nohup node monitoring-to-database-bridge.js > /tmp/bridge.log 2>&1 &
sleep 2
nohup node continuous-metrics-emitter.js > /tmp/emitter.log 2>&1 &

# 7. Verify
ps aux | grep -E 'monitoring-server|database-api-server|bridge|emitter' | grep node
```

---

## 10. QUICK REFERENCE

### Files to backup: 9
### Total size: ~60KB
### Backup frequency: Before any changes
### Storage location: Local machine + cloud (optional)

### Essential ports:
- 3001: monitoring-server (Socket.IO)
- 8083: database-api-server (HTTP API)

### Cloudflare tunnel (separate):
- Exposes port 8083 publicly
- URL changes on restart (temp tunnel mode)

---

**END OF BACKUP PLAN**

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station 3 Monitoring - Real-time Metrics</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status.connected {
            background: #4caf50;
        }

        .status.disconnected {
            background: #f44336;
        }

        .extensions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .extension-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .extension-card h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
        }

        .metric.warning {
            border-left-color: #ff9800;
        }

        .metric.critical {
            border-left-color: #f44336;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .alerts {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .alert-item {
            background: rgba(255, 152, 0, 0.2);
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .alert-item.critical {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #f44336;
        }

        .stats {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4caf50;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .raw-data {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Station 3 Monitoring</h1>
        <div>STTTTSserver ‚Üí Deepgram (Pre-ASR Audio Analysis)</div>
        <div class="status" id="connectionStatus">Connecting...</div>
    </div>

    <div class="extensions">
        <div class="extension-card" id="ext3333">
            <h2>Extension 3333</h2>
            <div class="metric-grid" id="metrics3333">
                <div class="metric">
                    <div class="metric-label">Waiting for data...</div>
                    <div class="metric-value">--</div>
                </div>
            </div>
        </div>

        <div class="extension-card" id="ext4444">
            <h2>Extension 4444</h2>
            <div class="metric-grid" id="metrics4444">
                <div class="metric">
                    <div class="metric-label">Waiting for data...</div>
                    <div class="metric-value">--</div>
                </div>
            </div>
        </div>
    </div>

    <div class="alerts" id="alertsSection" style="display: none;">
        <h3>‚ö†Ô∏è Active Alerts</h3>
        <div id="alertsList"></div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="totalMetrics">0</div>
            <div class="stat-label">Metrics Collected</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="successRate">100%</div>
            <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="alertCount">0</div>
            <div class="stat-label">Total Alerts</div>
        </div>
    </div>

    <div class="raw-data">
        <h3>üìä Raw Data Log</h3>
        <pre id="rawLog"></pre>
    </div>

    <script>
        const socket = io();
        let logEntries = [];

        socket.on('connect', () => {
            const status = document.getElementById('connectionStatus');
            status.textContent = 'Connected ‚úì';
            status.className = 'status connected';
            addLog('Socket.IO connected');
        });

        socket.on('disconnect', () => {
            const status = document.getElementById('connectionStatus');
            status.textContent = 'Disconnected ‚úó';
            status.className = 'status disconnected';
            addLog('Socket.IO disconnected');
        });

        socket.on('station3_metrics', (data) => {
            addLog(`Received metrics from ${data.extension}: ${Object.keys(data.metrics).length} parameters`);
            updateMetrics(data);
        });

        function updateMetrics(data) {
            const { extension, metrics, alerts, stats } = data;
            const container = document.getElementById(`metrics${extension}`);

            // Clear and rebuild metrics
            container.innerHTML = '';

            // Group metrics by category
            const categories = {
                'Audio Quality': ['audioQuality.snr', 'audioQuality.speechLevel', 'audioQuality.clipping', 'audioQuality.noise'],
                'DSP': ['dsp.agc.currentGain', 'dsp.noiseReduction.noiseLevel'],
                'Performance': ['performance.cpu', 'performance.memory', 'performance.bandwidth'],
                'Buffer & Latency': ['buffer.processing', 'latency.processing'],
                'Custom': ['custom.state', 'custom.successRate', 'custom.totalProcessed']
            };

            for (const [category, keys] of Object.entries(categories)) {
                for (const key of keys) {
                    if (metrics[key] !== undefined && metrics[key] !== null) {
                        const div = document.createElement('div');
                        div.className = 'metric';

                        // Check if this metric has an alert
                        const alert = alerts.find(a => a.metric === key);
                        if (alert) {
                            div.classList.add(alert.level);
                        }

                        const label = document.createElement('div');
                        label.className = 'metric-label';
                        label.textContent = key.split('.').pop();

                        const value = document.createElement('div');
                        value.className = 'metric-value';

                        // Format value based on type
                        let formatted = metrics[key];
                        if (typeof formatted === 'number') {
                            if (key.includes('cpu') || key.includes('Rate')) {
                                formatted = formatted.toFixed(1) + '%';
                            } else if (key.includes('Level') || key.includes('snr') || key.includes('Gain')) {
                                formatted = formatted.toFixed(1) + ' dB';
                            } else if (key.includes('memory')) {
                                formatted = (formatted * 100).toFixed(1) + '%';
                            } else {
                                formatted = formatted.toFixed(2);
                            }
                        }

                        value.textContent = formatted;

                        div.appendChild(label);
                        div.appendChild(value);
                        container.appendChild(div);
                    }
                }
            }

            // Update alerts
            if (alerts && alerts.length > 0) {
                document.getElementById('alertsSection').style.display = 'block';
                const alertsList = document.getElementById('alertsList');
                alertsList.innerHTML = '';

                alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = `alert-item ${alert.level}`;
                    div.innerHTML = `
                        <strong>${alert.metric}</strong>: ${alert.message}
                        <br><small>Value: ${alert.value}, Threshold: ${alert.threshold}</small>
                    `;
                    alertsList.appendChild(div);
                });
            }

            // Update stats
            if (stats) {
                document.getElementById('totalMetrics').textContent = stats.totalProcessed || 0;
                document.getElementById('successRate').textContent = (stats.successRate || 100).toFixed(1) + '%';
                document.getElementById('alertCount').textContent = (stats.warningCount || 0) + (stats.criticalCount || 0);
            }
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.unshift(`[${timestamp}] ${message}`);
            if (logEntries.length > 50) logEntries.pop();
            document.getElementById('rawLog').textContent = logEntries.join('\n');
        }

        // Log all Socket.IO events for debugging
        socket.onAny((event, ...args) => {
            addLog(`Event: ${event}`);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Audio Monitor - Enhanced Controls</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .status-bar {
            background: #1e1e3e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .status-light.connected {
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }

        .status-light.disconnected {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
        }

        .stations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .station-card {
            background: linear-gradient(145deg, #1e1e3e, #2a2a4e);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s;
        }

        .station-card:hover {
            transform: translateY(-2px);
        }

        .station-header {
            margin-bottom: 20px;
        }

        .station-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 10px;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .audio-controls button {
            padding: 8px 15px;
            background: #2a4a6a;
            color: white;
            border: 1px solid #3a5a7a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .audio-controls button:hover:not(:disabled) {
            background: #3a5a8a;
            box-shadow: 0 2px 8px rgba(58, 90, 138, 0.5);
        }

        .audio-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .audio-controls button.active {
            background: #00aa44;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* Enhanced Volume Control Styling */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(145deg, #1a1a3a, #252545);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 0, 0.2);
        }

        .volume-label {
            color: #00ff00;
            font-weight: bold;
            min-width: 60px;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .volume-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: linear-gradient(to right,
                #00ff00 0%,
                #00ff00 var(--value),
                #444 var(--value),
                #444 100%);
            outline: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .volume-slider:hover {
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        /* Chrome/Safari slider thumb */
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #00ff00, #00aa00);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            transition: all 0.3s;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            width: 24px;
            height: 24px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        }

        .volume-slider::-webkit-slider-thumb:active {
            background: radial-gradient(circle, #00ff00, #00ff00);
            box-shadow: 0 0 25px rgba(0, 255, 0, 1);
        }

        /* Firefox slider thumb */
        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #00ff00, #00aa00);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
            transition: all 0.3s;
        }

        .volume-slider::-moz-range-thumb:hover {
            width: 24px;
            height: 24px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        }

        .volume-slider::-moz-range-thumb:active {
            background: radial-gradient(circle, #00ff00, #00ff00);
            box-shadow: 0 0 25px rgba(0, 255, 0, 1);
        }

        .volume-value {
            color: #00ff00;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
            font-size: 1.1em;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            background: #0a0e1a;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff00;
        }

        .log-container {
            background: #0a0e1a;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #333;
            transition: all 0.3s;
        }

        .log-entry.info {
            border-color: #3a5a8a;
            color: #8ab4f8;
        }

        .log-entry.success {
            border-color: #00ff00;
            color: #00ff00;
        }

        .log-entry.error {
            border-color: #ff4444;
            color: #ff8888;
        }

        .log-entry.audio {
            border-color: #ffaa00;
            color: #ffcc66;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ§ Real-Time Audio Monitor - Enhanced Controls</h1>

        <div class="status-bar">
            <div class="status-indicator">
                <div id="statusLight" class="status-light disconnected"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div>
                <span id="serverUrl">-</span>
            </div>
        </div>

        <div class="stations-grid">
            <!-- Extension 3333 -->
            <div class="station-card">
                <div class="station-header">
                    <div class="station-title">Extension 3333 (English)</div>
                    <div class="audio-controls">
                        <button onclick="toggleSubscription('3333')" id="subBtn3333">Subscribe</button>
                        <button onclick="toggleLivePlayback('3333')" id="liveBtn3333" disabled>ðŸ”Š Live Audio</button>
                        <button onclick="playBuffered('3333')" id="playBtn3333" disabled>â–¶ Play Buffer</button>
                    </div>
                </div>

                <div class="volume-control">
                    <span class="volume-label">Volume:</span>
                    <input type="range"
                           class="volume-slider"
                           id="volume3333"
                           min="0"
                           max="100"
                           value="50"
                           style="--value: 50%;">
                    <span class="volume-value" id="volumeVal3333">50%</span>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Packets</div>
                        <div class="stat-value" id="packets3333">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Data Rate</div>
                        <div class="stat-value" id="rate3333">0 KB/s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Buffer</div>
                        <div class="stat-value" id="buffer3333">0 KB</div>
                    </div>
                </div>
            </div>

            <!-- Extension 4444 -->
            <div class="station-card">
                <div class="station-header">
                    <div class="station-title">Extension 4444 (French)</div>
                    <div class="audio-controls">
                        <button onclick="toggleSubscription('4444')" id="subBtn4444">Subscribe</button>
                        <button onclick="toggleLivePlayback('4444')" id="liveBtn4444" disabled>ðŸ”Š Live Audio</button>
                        <button onclick="playBuffered('4444')" id="playBtn4444" disabled>â–¶ Play Buffer</button>
                    </div>
                </div>

                <div class="volume-control">
                    <span class="volume-label">Volume:</span>
                    <input type="range"
                           class="volume-slider"
                           id="volume4444"
                           min="0"
                           max="100"
                           value="50"
                           style="--value: 50%;">
                    <span class="volume-value" id="volumeVal4444">50%</span>
                </div>

                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Packets</div>
                        <div class="stat-value" id="packets4444">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Data Rate</div>
                        <div class="stat-value" id="rate4444">0 KB/s</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Buffer</div>
                        <div class="stat-value" id="buffer4444">0 KB</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-container" id="logContainer">
            <div class="log-entry info">System initialized. Ready to connect...</div>
        </div>
    </div>

    <script>
        let socket = null;
        const serverUrl = 'http://' + window.location.hostname + ':3020';

        // Audio state for each extension
        const audioState = {
            '3333': {
                subscribed: false,
                audioContext: null,
                gainNode: null,
                audioBuffer: [],
                packetCount: 0,
                dataRate: 0,
                lastDataTime: 0,
                livePlayback: false,
                volume: 50
            },
            '4444': {
                subscribed: false,
                audioContext: null,
                gainNode: null,
                audioBuffer: [],
                packetCount: 0,
                dataRate: 0,
                lastDataTime: 0,
                livePlayback: false,
                volume: 50
            }
        };

        // Setup volume control event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup volume controls for both extensions
            ['3333', '4444'].forEach(ext => {
                const slider = document.getElementById('volume' + ext);
                const valueDisplay = document.getElementById('volumeVal' + ext);

                // Update on input (while dragging)
                slider.addEventListener('input', function() {
                    const value = this.value;
                    valueDisplay.textContent = value + '%';
                    // Update the gradient background
                    this.style.setProperty('--value', value + '%');
                    setVolume(ext, value);
                });

                // Also update on change (when finished dragging)
                slider.addEventListener('change', function() {
                    const value = this.value;
                    valueDisplay.textContent = value + '%';
                    this.style.setProperty('--value', value + '%');
                    setVolume(ext, value);
                });
            });

            // Connect to server
            connectToServer();
        });

        function connectToServer() {
            addLog('Connecting to server...', 'info');

            socket = io(serverUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000
            });

            socket.on('connect', () => {
                document.getElementById('statusLight').className = 'status-light connected';
                document.getElementById('statusText').textContent = 'Connected';
                document.getElementById('serverUrl').textContent = serverUrl;
                addLog('âœ… Connected to server', 'success');
            });

            socket.on('disconnect', () => {
                document.getElementById('statusLight').className = 'status-light disconnected';
                document.getElementById('statusText').textContent = 'Disconnected';
                addLog('âŒ Disconnected from server', 'error');
            });

            socket.on('audio-subscribed', (data) => {
                const { extensionId } = data;
                addLog('âœ… Subscribed to audio stream for extension ' + extensionId, 'success');
                document.getElementById('liveBtn' + extensionId).disabled = false;
                document.getElementById('playBtn' + extensionId).disabled = false;
            });

            socket.on('audio-data', (data) => {
                handleAudioData(data);
            });

            socket.on('error', (error) => {
                addLog('Error: ' + (error.message || error), 'error');
            });
        }

        function toggleSubscription(extensionId) {
            const state = audioState[extensionId];
            const btn = document.getElementById('subBtn' + extensionId);

            if (!state.subscribed) {
                socket.emit('subscribe-audio', { extensionId: extensionId });
                state.subscribed = true;
                btn.textContent = 'Unsubscribe';
                btn.classList.add('active');
                addLog('Subscribing to extension ' + extensionId + '...', 'info');

                // Initialize audio context if needed
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    state.gainNode = state.audioContext.createGain();
                    state.gainNode.connect(state.audioContext.destination);
                    state.gainNode.gain.value = state.volume / 100;
                }
            } else {
                socket.emit('unsubscribe-audio', { extensionId: extensionId });
                state.subscribed = false;
                state.livePlayback = false;
                btn.textContent = 'Subscribe';
                btn.classList.remove('active');
                document.getElementById('liveBtn' + extensionId).classList.remove('active');
                document.getElementById('liveBtn' + extensionId).disabled = true;
                document.getElementById('playBtn' + extensionId).disabled = true;
                addLog('Unsubscribed from extension ' + extensionId, 'info');
            }
        }

        function handleAudioData(data) {
            const extensionId = data.extensionId;
            const audioBase64 = data.data;
            const timestamp = data.timestamp;
            const sequenceNumber = data.sequenceNumber;
            const state = audioState[extensionId];

            if (!state.subscribed) return;

            // Decode base64 to ArrayBuffer
            const binaryString = atob(audioBase64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // Add to buffer
            state.audioBuffer.push(bytes);
            if (state.audioBuffer.length > 100) {
                state.audioBuffer.shift(); // Keep only last 100 packets
            }

            // Update stats
            state.packetCount++;
            const now = Date.now();
            if (state.lastDataTime > 0) {
                const timeDiff = (now - state.lastDataTime) / 1000;
                state.dataRate = (bytes.length / 1024) / timeDiff;
            }
            state.lastDataTime = now;

            // Update UI
            document.getElementById('packets' + extensionId).textContent = state.packetCount;
            document.getElementById('rate' + extensionId).textContent = state.dataRate.toFixed(1) + ' KB/s';
            document.getElementById('buffer' + extensionId).textContent =
                (state.audioBuffer.reduce((sum, buf) => sum + buf.length, 0) / 1024).toFixed(1) + ' KB';

            // Play live if enabled
            if (state.livePlayback && state.audioContext) {
                playPCMAudio(bytes, state.audioContext, state.gainNode);
            }

            // Log periodically
            if (state.packetCount % 50 === 0) {
                addLog('ðŸ“¡ Extension ' + extensionId + ': ' + state.packetCount + ' packets received', 'audio');
            }
        }

        function toggleLivePlayback(extensionId) {
            const state = audioState[extensionId];
            const btn = document.getElementById('liveBtn' + extensionId);

            state.livePlayback = !state.livePlayback;

            if (state.livePlayback) {
                btn.classList.add('active');
                btn.textContent = 'ðŸ”‡ Mute';
                addLog('ðŸ”Š Live playback enabled for extension ' + extensionId, 'success');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ðŸ”Š Live Audio';
                addLog('ðŸ”‡ Live playback disabled for extension ' + extensionId, 'info');
            }
        }

        function playBuffered(extensionId) {
            const state = audioState[extensionId];

            if (!state.audioContext || state.audioBuffer.length === 0) {
                addLog('No buffered audio for extension ' + extensionId, 'error');
                return;
            }

            // Combine all buffered audio
            const totalLength = state.audioBuffer.reduce((sum, buf) => sum + buf.length, 0);
            const combinedBuffer = new Uint8Array(totalLength);
            let offset = 0;

            for (const buf of state.audioBuffer) {
                combinedBuffer.set(buf, offset);
                offset += buf.length;
            }

            // Convert to WAV and play
            const wavBuffer = pcmToWav(combinedBuffer);
            state.audioContext.decodeAudioData(wavBuffer.buffer, (audioBuffer) => {
                const source = state.audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(state.gainNode);
                source.start();
                addLog('â–¶ Playing buffered audio for extension ' + extensionId, 'audio');
            });
        }

        function setVolume(extensionId, value) {
            const state = audioState[extensionId];
            state.volume = parseInt(value);

            if (state.gainNode) {
                state.gainNode.gain.value = state.volume / 100;
            }
        }

        function playPCMAudio(pcmData, audioContext, gainNode) {
            const wavBuffer = pcmToWav(pcmData);

            audioContext.decodeAudioData(wavBuffer.buffer, (audioBuffer) => {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(gainNode);
                source.start();
            }).catch(err => {
                console.error('Audio decode error:', err);
            });
        }

        function pcmToWav(pcmData, sampleRate) {
            if (!sampleRate) sampleRate = 16000;
            const length = pcmData.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);

            // WAV header
            const writeString = function(offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);

            // Convert PCM data
            let offset = 44;
            for (let i = 0; i < length; i += 2) {
                const sample = (pcmData[i] | (pcmData[i + 1] << 8));
                view.setInt16(offset, sample, true);
                offset += 2;
            }

            return new Uint8Array(arrayBuffer);
        }

        function addLog(message, type) {
            if (!type) type = 'info';
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = '[' + timestamp + '] ' + message;
            container.appendChild(entry);

            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;

            // Keep only last 50 entries
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }
    </script>
</body>
</html>

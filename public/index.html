<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simultaneous Translation Conference</title>
    <link rel="stylesheet" href="/css/conference.css">
</head>
<body>
    <div class="app-container">
        <!-- Join Screen -->
        <div id="joinScreen" class="screen active">
            <div class="join-container">
                <h1>🌐 Simultaneous Translation Conference</h1>
                <p class="subtitle">Speak in your language, be heard in theirs</p>

                <div class="join-form">
                    <div class="form-group">
                        <label for="username">Your Name</label>
                        <input type="text" id="username" placeholder="Enter your name" required>
                    </div>

                    <div class="form-group">
                        <label for="language">Your Language</label>
                        <select id="language" required>
                            <option value="en">🇺🇸 English</option>
                            <option value="es">🇪🇸 Spanish</option>
                            <option value="fr">🇫🇷 French</option>
                            <option value="de">🇩🇪 German</option>
                            <option value="it">🇮🇹 Italian</option>
                            <option value="pt">🇵🇹 Portuguese</option>
                            <option value="ja">🇯🇵 Japanese</option>
                            <option value="ko">🇰🇷 Korean</option>
                            <option value="zh">🇨🇳 Chinese</option>
                            <option value="ru">🇷🇺 Russian</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="audioTransport">Audio Connection</label>
                        <select id="audioTransport">
                            <option value="webrtc">🌐 WebRTC (Browser Microphone)</option>
                            <option value="sip">📞 SIP/Asterisk (Telephony)</option>
                        </select>
                        <small style="display: block; margin-top: 4px; color: #666; font-size: 0.85em;">
                            WebRTC: Direct browser microphone (current) | SIP: Connect via Asterisk PBX
                        </small>
                    </div>

                    <!-- SIP Configuration (shown when SIP selected) -->
                    <div id="sipConfigSection" style="display: none; margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-top: 0; font-size: 0.95em; color: #333;">SIP Configuration</h4>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="sipServer" style="font-size: 0.9em;">SIP Server</label>
                            <input type="text" id="sipServer" value="ws://localhost:8088/ws" style="font-size: 0.9em;">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="sipUsername" style="font-size: 0.9em;">SIP Username</label>
                            <input type="text" id="sipUsername" value="caller1" style="font-size: 0.9em;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="sipPassword" style="font-size: 0.9em;">SIP Password</label>
                            <input type="password" id="sipPassword" value="secret123" style="font-size: 0.9em;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="customVoice">Voice (optional - choose a custom voice)</label>
                        <select id="customVoice">
                            <option value="">Default (language-based)</option>
                        </select>
                        <div class="voice-preview-container" style="margin-top: 8px; display: none;">
                            <button type="button" id="previewVoiceBtn" class="btn btn-small btn-secondary" style="font-size: 0.9em; padding: 6px 12px;">
                                🔊 Preview Voice
                            </button>
                            <span id="previewStatus" style="margin-left: 10px; font-size: 0.85em; color: #666;"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="roomId">Room ID (leave empty to create new)</label>
                        <input type="text" id="roomId" placeholder="Enter room ID or leave blank">
                    </div>

                    <button id="joinBtn" class="btn btn-primary btn-large">
                        Join Conference
                    </button>

                    <div class="info-box">
                        <p><strong>How it works:</strong></p>
                        <ul>
                            <li>Speak in your native language</li>
                            <li>Everyone hears you in their language</li>
                            <li>Maximum latency: 2000ms</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calibration Options Screen (shown after join but before conference) -->
        <div id="calibrationOptionsScreen" class="screen">
            <div class="join-container">
                <div class="logo">🎤</div>
                <h1>Voice Calibration Options</h1>
                <p class="subtitle">Choose how to proceed with <strong id="calibrationLanguageName">your language</strong></p>

                <!-- Option 1: Continue with existing profile -->
                <div id="existingProfileOption" class="option-section" style="display: none;">
                    <div class="option-card option-primary">
                        <div class="option-icon">✅</div>
                        <h3>Continue with Your Profile</h3>
                        <p>Use your existing voice calibration for <strong id="profileLangDisplay">this language</strong></p>
                        <div class="profile-info">
                            <span class="profile-label">Username:</span>
                            <span class="profile-value" id="usernameDisplay">Loading...</span>
                        </div>
                        <div class="profile-info">
                            <span class="profile-label">Profile ID:</span>
                            <span class="profile-value" id="profileIdDisplay">Loading...</span>
                        </div>
                        <button id="useExistingProfileBtn" class="btn btn-option btn-primary">
                            Continue with Profile
                        </button>
                    </div>
                </div>

                <!-- Option 2: Perform calibration -->
                <div class="option-section">
                    <div class="option-card option-highlighted">
                        <div class="option-badge">RECOMMENDED</div>
                        <div class="option-icon">🎯</div>
                        <h3>Perform Voice Calibration</h3>
                        <p>Get personalized speech recognition (2-3 minutes)</p>
                        <div class="benefits-list">
                            <span class="benefit">✨ +10-15% accuracy</span>
                            <span class="benefit">🎯 Learns your accent</span>
                            <span class="benefit">🔒 Private & secure</span>
                        </div>
                        <button id="startCalibrationFromJoinBtn" class="btn btn-option btn-success">
                            Start Calibration
                        </button>
                    </div>
                </div>

                <!-- Option 3: Skip calibration -->
                <div class="option-section">
                    <div class="option-card option-simple">
                        <div class="option-icon">⚡</div>
                        <h3>Skip Calibration</h3>
                        <p>Use default settings for <strong id="defaultLangDisplay">this language</strong></p>
                        <div class="skip-note">
                            <small>⚠️ You can calibrate later from settings</small>
                        </div>
                        <button id="skipCalibrationFromJoinBtn" class="btn btn-option btn-secondary">
                            Continue Without Calibration
                        </button>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="info-box-small">
                    <strong>What is calibration?</strong>
                    <p>We analyze your voice to improve recognition of your unique accent, pronunciation, and speech patterns.</p>
                </div>
            </div>
        </div>

        <!-- Conference Screen -->
        <div id="conferenceScreen" class="screen">
            <div class="conference-container">
                <!-- Header -->
                <div class="conference-header">
                    <div class="room-info">
                        <h2>Conference Room</h2>
                        <div class="room-details">
                            <span class="room-id">Room: <strong id="currentRoomId">-</strong></span>
                            <span class="user-lang">Your Language: <strong id="currentLanguage">-</strong></span>
                        </div>
                    </div>
                    <button id="leaveBtn" class="btn btn-danger">Leave Room</button>
                </div>

                <!-- Main Content -->
                <div class="conference-content">
                    <!-- Participants Panel -->
                    <div class="participants-panel">
                        <h3>Participants (<span id="participantCount">0</span>)</h3>
                        <div id="participantsList" class="participants-list"></div>
                    </div>

                    <!-- Audio Control Panel -->
                    <div class="audio-panel">
                        <div class="audio-visualizer">
                            <canvas id="audioVisualizer" width="600" height="100"></canvas>
                        </div>

                        <!-- Latency Stats -->
                        <div class="latency-stats">
                            <span class="latency-item">Last Latency: <strong id="latencyStat">-</strong></span>
                            <span class="latency-item">Avg (1min): <strong id="avgLatencyStat" style="font-size: 1.2em;">-</strong></span>
                        </div>

                        <div class="controls">
                            <button id="toggleMicBtn" class="btn btn-mic">
                                <span class="mic-icon">🎤</span>
                                <span class="btn-text">Start Speaking</span>
                            </button>

                            <div class="status-display">
                                <div class="status-indicator" id="statusIndicator"></div>
                                <span id="statusText">Ready to speak</span>
                            </div>
                        </div>

                        <!-- Transcription Display -->
                        <div class="transcription-box">
                            <h4>What you're saying:</h4>
                            <div id="transcriptionDisplay" class="transcription-text">
                                <p class="placeholder">Your speech will appear here...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Translation Feed -->
                    <div class="translation-panel">
                        <h3>Translation Feed</h3>
                        <div id="translationFeed" class="translation-feed">
                            <p class="placeholder">Translations will appear here...</p>
                        </div>
                    </div>
                </div>

                <!-- Pipeline Log Panel -->
                <div class="pipeline-log-panel">
                    <div class="log-header">
                        <h3>Pipeline Log</h3>
                        <div class="log-actions">
                            <button id="exportLogBtn" class="btn btn-small btn-success" onclick="exportLogsToCSV()">📊 Export CSV</button>
                            <button id="clearLogBtn" class="btn btn-small">Clear</button>
                        </div>
                    </div>
                    <div id="pipelineLog" class="pipeline-log">
                        <p class="placeholder">Pipeline events will appear here...</p>
                    </div>
                </div>

                <!-- Footer Stats -->
                <div class="conference-footer">
                    <div class="stats">
                        <span>Connection: <strong id="connectionStatus">Connecting...</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for playback -->
    <audio id="audioPlayer" controls autoplay style="display: none;"></audio>

    <!-- Socket.io client -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- SIP.js library (for SIP transport option) -->
    <!-- Using local npm package served as ES6 module -->
    <script type="module">
        // Import SimpleUser and expose it globally
        import { SimpleUser } from '/node_modules/sip.js/lib/platform/web/simple-user/simple-user.js';
        window.SimpleUser = SimpleUser;
        console.log('[SIP.js] Library loaded successfully, SimpleUser exposed globally');
    </script>

    <!-- Audio transport abstraction layer -->
    <script src="/js/audio-transport.js?v=1760564600000"></script>

    <!-- Conference app script with built-in silence detection -->
    <script src="/js/conference-silence-detection.js?v=1760564600000"></script>
</body>
</html>
